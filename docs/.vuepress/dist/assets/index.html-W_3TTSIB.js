import{_ as i,c as e,d as a,o as t}from"./app-v0hYxepB.js";const h={};function n(l,s){return t(),e("div",null,s[0]||(s[0]=[a(`<h2 id="pci-设备直通" tabindex="-1"><a class="header-anchor" href="#pci-设备直通"><span>PCI 设备直通</span></a></h2><p><strong>VMware ESXi</strong> 环境下的一种底层直通机制，通过手动编辑 <code>passthru.map</code> 文件来实现 PCI 设备的直通控制。这个方案适用于<strong>将物理控制器设备（如 SATA 控制器）Passthrough 给虚拟机</strong>，它是 <strong>PCI Passthrough（设备直通）</strong> 的一种方式。</p><hr><h3 id="🔍-详细解释" tabindex="-1"><a class="header-anchor" href="#🔍-详细解释"><span>🔍 详细解释：</span></a></h3><h4 id="你执行的命令" tabindex="-1"><a class="header-anchor" href="#你执行的命令"><span>你执行的命令：</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lspci</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -v</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Class 0106</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -B</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>输出：</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-ini"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">0000:00:17.0 Mass storage controller SATA controller: Intel Corporation Comet Lake SATA AHCI Controller </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">         Class 0106: 8086:06d2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>说明你的 ESXi 主机上有一块 <strong>SATA AHCI 控制器（类代码 0106）</strong>，其 PCI ID 是 <code>8086:06d2</code>。</p><hr><h4 id="修改-passthru-map-文件" tabindex="-1"><a class="header-anchor" href="#修改-passthru-map-文件"><span>修改 <code>passthru.map</code> 文件：</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vi</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/vmware/passthru.map</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 添加以下内容</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">8086</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   06d2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    d3d0</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>字段含义如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>VendorID  DeviceID  SubsystemID  passthru</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>8086</code>：Intel 的厂商 ID</li><li><code>06d2</code>：设备 ID</li><li><code>d3d0</code>：子系统 ID（可任意填，常见写法）</li><li><code>false</code>：表示不启用 MSI/MSI-X，适用于部分直通设备需要禁用中断映射</li></ul><hr><h3 id="✅-这是哪种直通方案" tabindex="-1"><a class="header-anchor" href="#✅-这是哪种直通方案"><span>✅ 这是哪种直通方案？</span></a></h3><p>这是 <strong>VMware ESXi 的 PCI Device Passthrough</strong>（也称 DirectPath I/O）：</p><blockquote><p>允许将物理主机的 PCI 设备（如网卡、SATA 控制器、NVMe 控制器等）<strong>直接分配给虚拟机使用</strong>，绕过 hypervisor 的抽象层，从而提升性能或实现直接硬件访问。</p></blockquote><hr><h3 id="⚠️-注意事项" tabindex="-1"><a class="header-anchor" href="#⚠️-注意事项"><span>⚠️ 注意事项：</span></a></h3><ol><li>使用这种方式直通 SATA 控制器后，该控制器下挂载的物理硬盘将<strong>不再被 ESXi 识别</strong>，而只能由直通到的虚拟机使用。</li><li>有些主板的 SATA 控制器不支持 IOMMU 隔离，可能导致 passthrough 失败。</li><li>配置完成后，需重启 ESXi 并在虚拟机设置中添加对应的 PCI 设备。</li></ol><hr><h3 id="🧩-附加建议" tabindex="-1"><a class="header-anchor" href="#🧩-附加建议"><span>🧩 附加建议：</span></a></h3><p>要检查 IOMMU 和直通可用状态，可以在 ESXi Shell 中执行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vmkchdev</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 06d2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>要启用 passthrough：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vmkchdev</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -v</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 0000:00:17.0</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><p>如你希望进一步直通硬盘本身而非控制器，也可以考虑使用 <strong>RDM（Raw Device Mapping）</strong>，这两者用途略有不同：</p><table><thead><tr><th>方案</th><th>用途</th><th>适用场景</th></tr></thead><tbody><tr><td>PCI Passthrough</td><td>直通整个 SATA/NVMe 控制器</td><td>高性能、ZFS、软 RAID 场景</td></tr><tr><td>RDM</td><td>直通单块物理硬盘</td><td>精细控制单块磁盘映射</td></tr></tbody></table><p>如果你告诉我你想用它来运行什么系统（如 TrueNAS、Unraid、直通给 Linux 做 ZFS 等），我可以进一步帮你判断是否适合这种 passthrough。</p><h2 id="rdm-原始设备映射" tabindex="-1"><a class="header-anchor" href="#rdm-原始设备映射"><span>RDM 原始设备映射</span></a></h2><ul><li><p>创建一个 <strong>.vmdk 文件指向物理硬盘</strong>（ESXi 不直通控制器，仅传递磁盘路径）。</p></li><li><p>通过 <code>vmkfstools -z</code> 命令建立 RDM 映射，如：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vmkfstools</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -z</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /vmfs/devices/disks/t10.ATA_____Disk123456</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /vmfs/volumes/datastore1/vmname/disk1.vmdk</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul>`,34)]))}const d=i(h,[["render",n]]),p=JSON.parse('{"path":"/article/uvr6yekg/","title":"ESXi 直通 SATA 控制器","lang":"zh-CN","frontmatter":{"title":"ESXi 直通 SATA 控制器","createTime":"2025/05/28 22:20:25","permalink":"/article/uvr6yekg/","tags":["pci","esxi","vm"],"description":"PCI 设备直通 VMware ESXi 环境下的一种底层直通机制，通过手动编辑 passthru.map 文件来实现 PCI 设备的直通控制。这个方案适用于将物理控制器设备（如 SATA 控制器）Passthrough 给虚拟机，它是 PCI Passthrough（设备直通） 的一种方式。 🔍 详细解释： 你执行的命令： 输出： 说明你的 ESX...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ESXi 直通 SATA 控制器\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://powersen.cn/article/uvr6yekg/"}],["meta",{"property":"og:site_name","content":"Powersen"}],["meta",{"property":"og:title","content":"ESXi 直通 SATA 控制器"}],["meta",{"property":"og:description","content":"PCI 设备直通 VMware ESXi 环境下的一种底层直通机制，通过手动编辑 passthru.map 文件来实现 PCI 设备的直通控制。这个方案适用于将物理控制器设备（如 SATA 控制器）Passthrough 给虚拟机，它是 PCI Passthrough（设备直通） 的一种方式。 🔍 详细解释： 你执行的命令： 输出： 说明你的 ESX..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:tag","content":"vm"}],["meta",{"property":"article:tag","content":"esxi"}],["meta",{"property":"article:tag","content":"pci"}]]},"readingTime":{"minutes":2.1,"words":629},"git":{"createdTime":1750126639000},"autoDesc":true,"filePathRelative":"2.系统/3.ESXi/b-system-esxi-2.passthrough-sata-controller.md","headers":[],"categoryList":[{"id":"b3a06a","sort":2,"name":"系统"},{"id":"d8fa68","sort":3,"name":"ESXi"}]}');export{d as comp,p as data};
